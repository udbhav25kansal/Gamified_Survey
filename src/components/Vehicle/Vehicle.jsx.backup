import React, { useRef, useEffect } from 'react';
import { useFrame, useThree } from '@react-three/fiber';
import { useRaycastVehicle, useBox } from '@react-three/cannon';
import { useControls } from '../../hooks/useControls';
import { useBrand } from '../../context/BrandContext';
import * as THREE from 'three';

// ... Wheel Component (Same as before) ...
const Wheel = React.forwardRef(({ radius, ...props }, ref) => {
    return (
        <group ref={ref} {...props}>
            {/* Tire */}
            <mesh rotation={[Math.PI / 2, 0, 0]} castShadow>
                <cylinderGeometry args={[radius, radius, 0.4, 16]} />
                <meshStandardMaterial
                    color="#222"
                    roughness={0.8}
                    metalness={0.3}
                />
            </mesh>
            {/* Glowing Rim */}
            <mesh rotation={[Math.PI / 2, 0, 0]}>
                <cylinderGeometry args={[radius * 0.5, radius * 0.5, 0.41, 16]} />
                <meshStandardMaterial
                    color="#E6007E"
                    emissive="#E6007E"
                    emissiveIntensity={1.5}
                    metalness={1}
                    roughness={0.2}
                />
            </mesh>
        </group>
    );
});

const CameraRig = ({ target }) => {
    const { camera } = useThree();
    const offset = new THREE.Vector3(0, 5, 10);

    useFrame(() => {
        if (!target.current) return;

        // Get position from the physics body mesh
        const pos = new THREE.Vector3();
        target.current.getWorldPosition(pos);

        const desiredPos = pos.clone().add(offset);
        camera.position.lerp(desiredPos, 0.1);
        camera.lookAt(pos);
    });

    return null;
};

const Vehicle = ({ position = [0, 2, 0] }) => {
    const { brand } = useBrand();
    const { forward, backward, left, right, brake, reset } = useControls();

    // Chassis Physics
    const chassisWidth = 1.2;
    const chassisHeight = 0.5;
    const chassisLength = 2.5;
    const mass = 150;

    const [chassisBody, chassisApi] = useBox(() => ({
        mass,
        position,
        args: [chassisWidth, chassisHeight, chassisLength],
        allowSleep: false,
        onCollide: (e) => { },
    }), useRef(null));

    // Explicitly declare refs to ensure Hook order is stable
    const wheel1 = useRef(null);
    const wheel2 = useRef(null);
    const wheel3 = useRef(null);
    const wheel4 = useRef(null);
    const wheels = [wheel1, wheel2, wheel3, wheel4];

    // Wheel Config
    const wheelInfo = {
        radius: 0.35,
        directionLocal: [0, -1, 0],
        suspensionStiffness: 30,
        suspensionRestLength: 0.3,
        maxSuspensionForce: 100000,
        maxSuspensionTravel: 0.3,
        dampingRelaxation: 2.3,
        dampingCompression: 4.4,
        axleLocal: [-1, 0, 0],
        chassisConnectionPointLocal: [1, 0, 1],
        useCustomSlidingRotationalSpeed: true,
        customSlidingRotationalSpeed: -30,
        frictionSlip: 2,
    };

    const wheelInfos = [
        { ...wheelInfo, isFrontWheel: true, chassisConnectionPointLocal: [-0.8, -0.3, 1] },
        { ...wheelInfo, isFrontWheel: true, chassisConnectionPointLocal: [0.8, -0.3, 1] },
        { ...wheelInfo, isFrontWheel: false, chassisConnectionPointLocal: [-0.8, -0.3, -1] },
        { ...wheelInfo, isFrontWheel: false, chassisConnectionPointLocal: [0.8, -0.3, -1] },
    ];

    const [vehicle, vehicleApi] = useRaycastVehicle(() => ({
        chassisBody,
        wheels,
        wheelInfos,
    }), useRef(null));

    useFrame(() => {
        if (!vehicleApi) return;
        const engineForce = forward ? 1500 : backward ? -1000 : 0;
        const steeringValue = left ? 0.5 : right ? -0.5 : 0;
        const brakeForce = brake ? 50 : 0;

        vehicleApi.applyEngineForce(engineForce, 2);
        vehicleApi.applyEngineForce(engineForce, 3);
        vehicleApi.setSteeringValue(steeringValue, 0);
        vehicleApi.setSteeringValue(steeringValue, 1);
        vehicleApi.setBrake(brakeForce, 0);
        vehicleApi.setBrake(brakeForce, 1);
        vehicleApi.setBrake(brakeForce, 2);
        vehicleApi.setBrake(brakeForce, 3);

        if (reset) {
            chassisApi.position.set(0, 2, 0);
            chassisApi.velocity.set(0, 0, 0);
            chassisApi.angularVelocity.set(0, 0, 0);
            chassisApi.rotation.set(0, 0, 0);
        }
    });

    return (
        <group ref={vehicle} name="vehicle">
            <CameraRig target={chassisBody} />

            {/* Chassis */}
            <mesh ref={chassisBody} name="chassis" castShadow>
                <boxGeometry args={[chassisWidth, chassisHeight, chassisLength]} />
                <meshStandardMaterial
                    color="#E6007E"
                    emissive="#E6007E"
                    emissiveIntensity={0.5}
                    metalness={0.8}
                    roughness={0.2}
                />

                {/* Windshield/Cockpit */}
                <mesh position={[0, 0.25, 0.8]}>
                    <boxGeometry args={[1.1, 0.4, 1]} />
                    <meshStandardMaterial
                        color="#00D4FF"
                        transparent
                        opacity={0.4}
                        metalness={1}
                        roughness={0}
                    />
                </mesh>

                {/* Headlights with actual light */}
                <pointLight
                    position={[0, 0, 1.3]}
                    intensity={3}
                    distance={20}
                    color="white"
                    castShadow
                />
                <mesh position={[-0.4, 0, 1.3]}>
                    <sphereGeometry args={[0.12, 8, 8]} />
                    <meshStandardMaterial
                        color="white"
                        emissive="white"
                        emissiveIntensity={5}
                    />
                </mesh>
                <mesh position={[0.4, 0, 1.3]}>
                    <sphereGeometry args={[0.12, 8, 8]} />
                    <meshStandardMaterial
                        color="white"
                        emissive="white"
                        emissiveIntensity={5}
                    />
                </mesh>

                {/* Tail lights */}
                <mesh position={[-0.4, 0, -1.3]}>
                    <sphereGeometry args={[0.08, 8, 8]} />
                    <meshStandardMaterial
                        color="red"
                        emissive="red"
                        emissiveIntensity={3}
                    />
                </mesh>
                <mesh position={[0.4, 0, -1.3]}>
                    <sphereGeometry args={[0.08, 8, 8]} />
                    <meshStandardMaterial
                        color="red"
                        emissive="red"
                        emissiveIntensity={3}
                    />
                </mesh>
            </mesh>

            {/* Wheels */}
            {wheels.map((ref, i) => (
                <Wheel key={i} ref={ref} radius={wheelInfo.radius} />
            ))}
        </group>
    );
};

export default Vehicle;
